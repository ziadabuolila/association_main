<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../img/association.png" />
    <link rel="stylesheet" href="../css/table_login.css" />
    <title>المسجلين في جمعية الرحمة الخيرية بعزبة عمرو</title>

    <style>
      .status-msg {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        margin-top: 5px;
      }
      .status-msg.error {
        color: #d8000c;
      }
      .status-msg.success {
        color: #007f00;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <img src="../img/association.png" alt="Logo" draggable="false" />
      </div>
      <div class="company_name">
        <h4>جمعية الرحمة الخيرية بعزبة عمرو</h4>
      </div>
    </header>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>اسم المستخدم</th>
            <th>البريد الإلكتروني</th>
            <th>كلمة المرور</th>
            <th>منشئ في</th>
            <th>آخر تسجيل دخول</th>
            <th>حالة المستخدم</th>
            <th>الخيارات</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <script>
      const tableBody = document.getElementById("tableBody");
      let users = JSON.parse(localStorage.getItem("users")) || [];

      const LOCK_TIME = 60 * 1000;

      function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("ar-EG", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function renderTable() {
        tableBody.innerHTML = "";

        users.forEach((user, index) => {
          if (!user.status) user.status = "مفعل";
          if (user.failedAttempts === undefined) user.failedAttempts = 0;

          const lastLoginText = user.lastLogin
            ? formatDateTime(user.lastLogin)
            : "لم يتم تسجيل الدخول بعد";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${index + 1}</td>

            <td>
              <span class="text">${user.username}</span>
              <input class="edit-input" value="${user.username}" style="display:none">
            </td>

            <td>
              <span class="text">${user.email}</span>
              <input class="edit-input" value="${user.email}" style="display:none">
            </td>

            <td>
              <span class="text">${"*".repeat(user.password.length)}</span>
              <input class="edit-input" value="${user.password}" style="display:none">
            </td>

            <td>${user.createdAt || "-"}</td>
            <td>${lastLoginText}</td>

            <td>
              <span class="status-text ${
                user.status === "مفعل" ? "active" : "inactive"
              }">${user.status}</span>

              <select class="status-select" style="display:none">
                <option value="مفعل" ${user.status === "مفعل" ? "selected" : ""}>مفعل</option>
                <option value="غير مفعل" ${user.status === "غير مفعل" ? "selected" : ""}>غير مفعل</option>
                <option value="موقوف مؤقتًا" ${user.status === "موقوف مؤقتًا" ? "selected" : ""}>موقوف مؤقتًا</option>
                <option value="موقوف نهائيًا" ${user.status === "موقوف نهائيًا" ? "selected" : ""}>موقوف نهائيًا</option>
              </select>
            </td>

            <td>
              <button class="edit-btn" onclick="editRow(this, ${index})">تعديل</button>
              <button class="delete-btn" onclick="deleteRow(${index})">حذف</button>
            </td>
          `;

          tableBody.appendChild(tr);
        });

        localStorage.setItem("users", JSON.stringify(users));
      }

      function editRow(btn, index) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll(".edit-input");
        const texts = row.querySelectorAll(".text");
        const select = row.querySelector(".status-select");
        const statusText = row.querySelector(".status-text");

        if (btn.innerText === "تعديل") {
          texts.forEach((t) => (t.style.display = "none"));
          inputs.forEach((i) => (i.style.display = "block"));
          select.style.display = "block";
          statusText.style.display = "none";
          btn.innerText = "حفظ";
        } else {
          if (inputs[2].value.length < 8) {
            alert("كلمة المرور ضعيفة");
            return;
          }

          users[index].username = inputs[0].value;
          users[index].email = inputs[1].value;
          users[index].password = inputs[2].value;
          users[index].status = select.value;

          if (select.value === "موقوف مؤقتًا") {
            users[index].tempBlockedUntil = Date.now() + LOCK_TIME;
          } else {
            delete users[index].tempBlockedUntil;
          }

          renderTable();
        }
      }

      function deleteRow(index) {
        if (!confirm("هل أنت متأكد؟")) return;
        users.splice(index, 1);
        localStorage.setItem("users", JSON.stringify(users));
        renderTable();
      }

      renderTable();
    </script>
  </body>
</html>
